<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MTM - Skaner (pełny ekran)</title>
<link rel="stylesheet" href="/style.css">
<style>
  html,body{height:100%;margin:0;background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif}
  #video{position:fixed;left:0;top:0;width:100%;height:100%;object-fit:cover;z-index:1}
  #overlay{position:fixed;left:0;top:0;width:100%;height:100%;z-index:2;pointer-events:none;display:flex;align-items:center;justify-content:center}
  #message{
    pointer-events:auto;
    background:rgba(0,0,0,0.45);
    padding:18px 28px;border-radius:10px;border:2px solid rgba(255,255,255,0.08);
    font-size:28px;font-weight:700;text-align:center;max-width:90%;
    transition:opacity 0.25s, transform 0.25s;
  }
  .ok{color:#b7ffb7;text-shadow:0 2px 18px rgba(0,200,0,0.15)}
  .err{color:#ffb7b7;text-shadow:0 2px 18px rgba(200,0,0,0.15)}
  #logSmall{position:fixed;left:10px;bottom:10px;z-index:2;color:#fff;background:rgba(0,0,0,0.35);padding:8px;border-radius:6px;font-size:14px}
  #controls{position:fixed;right:10px;top:10px;z-index:2}
  #controls button{pointer-events:auto}
</style>
</head>
<body>
  <video id="video" autoplay muted playsinline></video>

  <div id="overlay" aria-live="polite" aria-atomic="true">
    <div id="message" style="opacity:0; transform:scale(0.9)"></div>
  </div>

  <div id="logSmall">Oczekiwanie na skan...</div>

  <div id="controls" style="z-index:3;">
    <button onclick="location.href='index.html'">Powrót</button>
  </div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
/* ---------- WebAudio helper: generuje beep/error bez plików ---------- */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audioCtx = AudioCtx ? new AudioCtx() : null;

function playTone({type='sine', freq=1000, duration=0.12, vol=0.15}) {
  if(!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type;
  o.frequency.value = freq;
  g.gain.value = vol;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  setTimeout(()=>{ o.stop(); }, duration*1000);
}

/* success beep and error buzz */
function playSuccess(){ playTone({type:'sine',freq:1200,duration:0.12,vol:0.15}); playTone({type:'sine',freq:1600,duration:0.06,vol:0.1}); }
function playError(){ playTone({type:'sawtooth',freq:300,duration:0.18,vol:0.18}); }

/* ---------- UI helpers ---------- */
const video = document.getElementById('video');
const message = document.getElementById('message');
const logSmall = document.getElementById('logSmall');
let msgTimer = null;

function showMessage(text, ok = true, time = 2500) {
  message.textContent = text;
  message.className = ok ? 'ok' : 'err';
  message.style.opacity = '1';
  message.style.transform = 'scale(1)';
  if(msgTimer) clearTimeout(msgTimer);
  msgTimer = setTimeout(()=> {
    message.style.opacity = '0';
    message.style.transform = 'scale(0.95)';
  }, time);
}

/* ---------- camera + scanning ---------- */
let lastScanned = new Set();

async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = stream;
    video.play();
    requestAnimationFrame(tick);
    logSmall.textContent = "Kamera uruchomiona, skanuj QR...";
  } catch (e) {
    logSmall.textContent = "Błąd kamery: " + (e.message || e);
    showMessage("❌ Błąd kamery", false, 5000);
    playError();
  }
}

function tick() {
  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const img = ctx.getImageData(0,0,canvas.width,canvas.height);
    const code = jsQR(img.data, img.width, img.height);
    if (code) {
      const txt = code.data;
      // zapobiegamy spamowi: to co zeskanowane trzymamy 4s
      if (!lastScanned.has(txt)) {
        lastScanned.add(txt);
        // wyswietl natychmiast feedback
        logSmall.textContent = "Zeskanowano: " + txt;
        // wyślij do serwera
        fetch('/api/scan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ qr: txt })
        }).then(r => r.json()).then(res => {
          if (res.success) {
            // res.message zawiera np. kod i serwer zwraca awizacja_id (jeśli skonfigurowano)
            showMessage("✅ Zeskanowano: " + (res.message || '').slice(0,60), true, 2500);
            playSuccess();
          } else {
            showMessage("❌ " + (res.message || res.error || 'Błąd'), false, 3000);
            playError();
          }
          // usuń po 4s żeby dać możliwość ponownego skanu
          setTimeout(()=> lastScanned.delete(txt), 4000);
        }).catch(err=>{
          showMessage("❌ Błąd sieci", false, 3000);
          playError();
          setTimeout(()=> lastScanned.delete(txt), 4000);
        });
      }
    }
  }
  requestAnimationFrame(tick);
}

startCamera();
</script>
</body>
</html>
