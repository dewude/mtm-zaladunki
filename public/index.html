<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <title>MTM System Awizacji - Strona GÅ‚Ã³wna</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css">
  <style>
    body { font-family: Arial, sans-serif; background:#f6f9fc; color:#222; padding:20px; }
    .center { text-align:center; }
    h1 { color:#064a7b; margin-bottom:20px; font-size:28px; }
    #formBox { max-width:760px; margin:0 auto 20px auto; background:white; padding:16px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.05); }
    input, textarea, select { width:100%; padding:8px; margin:6px 0; box-sizing:border-box; border:1px solid #e3e8ef; border-radius:6px; }
    button { background:#0b5ed7; color:white; padding:10px 14px; border:none; border-radius:6px; cursor:pointer; }
    .section { max-width:900px; margin:10px auto; text-align:left; }
    .card { background:white; border:1px solid #e3e8ef; padding:12px; border-radius:6px; margin-bottom:8px; cursor:pointer; }
    .card .actions { margin-top:8px; }
    .muted { color:#666; font-size:13px; }
    .hidden { display:none; }
    .topButtons { display:flex; gap:8px; justify-content:center; margin-bottom:12px; }
  </style>
</head>
<body>
  <div class="center">
    <h1>MTM System awizacji - Strona gÅ‚Ã³wna</h1>

    <div class="topButtons">
      <button onclick="toggleList('active')">ðŸ“‹ Aktywne awizacje</button>
      <button onclick="toggleList('finished')">âœ… ZakoÅ„czone</button>
      <button onclick="location.href='/skaner.html'">ðŸ“· Skaner</button>
      <button onclick="location.href='/app_worker.html'">ðŸ‘· Panel pracownika</button>
    </div>
  </div>

  <div id="formBox">
    <h2>Dodaj nowÄ… awizacjÄ™</h2>
    <div>
      <label>Numer zamÃ³wienia</label>
      <input id="nr_zam" placeholder="np. ZAM12345" />
      <label>Nazwa zamÃ³wienia</label>
      <input id="nazwa_zam" placeholder="np. Firma ABC" />
      <label>Numer auta</label>
      <input id="numer_auta" placeholder="np. PO12345" />
      <label>Kierowca</label>
      <input id="kierowca" placeholder="ImiÄ™ i nazwisko" />
      <label>Telefon</label>
      <input id="telefon" placeholder="+48 600 000 000" />
      <label>Data wyjazdu</label>
      <input id="data_wyjazdu" type="date" />
      <label>IloÅ›Ä‡ palet</label>
      <input id="ilosc_palet" type="number" min="1" value="1" />
      <label>Informacje dodatkowe</label>
      <textarea id="info" rows="3" placeholder="Dodatkowe uwagi"></textarea>
      <div style="text-align:right; margin-top:8px;">
        <button onclick="dodajAwizacje()">Dodaj awizacjÄ™</button>
      </div>
    </div>
  </div>

  <div id="activeList" class="section hidden">
    <h2>Aktywne awizacje</h2>
    <div id="activeContainer"></div>
  </div>

  <div id="finishedList" class="section hidden">
    <h2>ZakoÅ„czone awizacje</h2>
    <div id="finishedContainer"></div>
  </div>

<script>
  // toggle lists visibility
  function toggleList(which) {
    if (which === 'active') {
      document.getElementById('activeList').classList.toggle('hidden');
      if (!document.getElementById('activeList').classList.contains('hidden')) loadLists();
    } else {
      document.getElementById('finishedList').classList.toggle('hidden');
      if (!document.getElementById('finishedList').classList.contains('hidden')) loadLists();
    }
  }

  async function dodajAwizacje() {
    const payload = {
      nr_zam: document.getElementById('nr_zam').value.trim(),
      nazwa_zam: document.getElementById('nazwa_zam').value.trim(),
      numer_auta: document.getElementById('numer_auta').value.trim(),
      kierowca: document.getElementById('kierowca').value.trim(),
      telefon: document.getElementById('telefon').value.trim(),
      data_wyjazdu: document.getElementById('data_wyjazdu').value,
      ilosc_palet: parseInt(document.getElementById('ilosc_palet').value || "0", 10),
      info: document.getElementById('info').value.trim()
    };
    if (!payload.nr_zam) return alert('Podaj numer zamÃ³wienia');
    const res = await fetch('/api/awizacje', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const j = await res.json();
    if (j.status === 'ok') {
      alert('Dodano awizacjÄ™');
      // reset form
      ['nr_zam','nazwa_zam','numer_auta','kierowca','telefon','data_wyjazdu','ilosc_palet','info'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
      loadLists();
    } else {
      alert('BÅ‚Ä…d: ' + (j.message || j.status));
    }
  }

  async function loadLists() {
    const res = await fetch('/api/awizacje');
    const rows = await res.json();
    const active = rows.filter(r => r.status === 'aktywne' || r.status === 'active' || r.status === null);
    const finished = rows.filter(r => r.status === 'zakoÅ„czona' || r.status === 'finished');

    const activeContainer = document.getElementById('activeContainer');
    activeContainer.innerHTML = '';
    active.forEach(a => {
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <strong>${a.nr_zam || ''}</strong> â€” ${a.nazwa_zam || ''} <div class="muted">Auto: ${a.numer_auta || '-'} | Kierowca: ${a.kierowca || '-'} | Tel: ${a.telefon || '-'} </div>
        <div class="muted">Data wyjazdu: ${a.data_wyjazdu || '-'} | Palet: ${a.ilosc_palet || 0}</div>
        <div class="actions">
          <button onclick="showPalety(${a.id})">Palety</button>
          <button onclick="window.open('/api/drukuj_qr/${a.id}','_blank')">Drukuj QR</button>
          <button onclick="window.open('/api/drukuj_awizacje/${a.id}','_blank')">Drukuj awizacjÄ™</button>
          <button onclick="editAw(${a.id})">Edytuj</button>
          <button onclick="finishAw(${a.id})">ZakoÅ„cz</button>
          <button onclick="delAw(${a.id})">UsuÅ„</button>
        </div>
      `;
      activeContainer.appendChild(div);
    });

    const finishedContainer = document.getElementById('finishedContainer');
    finishedContainer.innerHTML = '';
    finished.forEach(a => {
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `<strong>${a.nr_zam || ''}</strong> â€” ${a.nazwa_zam || ''} <div class="muted">Data wyjazdu: ${a.data_wyjazdu || '-'} | Palet: ${a.ilosc_palet || 0}</div>
        <div class="actions">
          <button onclick="window.open('/api/drukuj_awizacje/${a.id}','_blank')">Drukuj awizacjÄ™</button>
          <button onclick="delAw(${a.id})">UsuÅ„ caÅ‚kowicie</button>
        </div>`;
      finishedContainer.appendChild(div);
    });
  }

  async function delAw(id) {
    if (!confirm('UsunÄ…Ä‡ awizacjÄ™?')) return;
    await fetch('/api/awizacje/' + id, { method: 'DELETE' });
    loadLists();
  }

  function editAw(id) {
    const nr = prompt('Nowy numer zamÃ³wienia (zostaw puste aby nie zmieniaÄ‡):');
    const data = prompt('Nowa data wyjazdu (YYYY-MM-DD):');
    const ilosc = prompt('Nowa iloÅ›Ä‡ palet:');
    const payload = {};
    if (nr) payload.nr_zam = nr;
    if (data) payload.data_wyjazdu = data;
    if (ilosc) payload.ilosc_palet = parseInt(ilosc,10);
    if (Object.keys(payload).length === 0) return;
    fetch('/api/awizacje/' + id, { method: 'PATCH', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) })
      .then(()=>loadLists());
  }

  function finishAw(id) {
    if (!confirm('ZakoÅ„czyÄ‡ awizacjÄ™?')) return;
    fetch('/api/awizacje/' + id + '/finish', { method: 'PATCH' }).then(()=>loadLists());
  }

  async function showPalety(awid) {
    const res = await fetch('/api/palety/' + awid);
    const pal = await res.json();
    let list = pal.map(p => `${p.paleta_nazwa} â€” status: ${p.status || 'niezeskanowana'}`).join('\\n');
    const add = confirm(list + '\\n\\nChcesz dodaÄ‡ nowÄ… paletÄ™ do tej awizacji?');
    if (add) {
      const name = prompt('Nazwa palety (np. Paleta 1):');
      if (!name) return;
      await fetch('/api/palety', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ awizacja_id: awid, paleta_nazwa: name }) });
      alert('Dodano paletÄ™');
      loadLists();
    }
  }

  // initial load
  // don't auto-open lists; user toggles them
  document.addEventListener('DOMContentLoaded', ()=>{
    // nothing until user opens lists
  });
</script>
</body>
</html>
