<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MTM - System Awizacji</title>
<link rel="stylesheet" href="/style.css">
<style>
  body { font-family: Arial; text-align: center; background: #f5f5f5; margin: 0; padding: 20px; }
  h1 { font-size: 32px; color: #064a7b; margin-bottom: 30px; }
  button { padding: 10px 20px; margin: 5px; font-size: 16px; border: none; border-radius: 6px; background: #0b5ed7; color: #fff; cursor: pointer; }
  button:hover { background: #0d6efd; }
  .awizacja { background: #fff; border: 1px solid #e3e8ef; padding: 12px; margin-bottom: 10px; border-radius: 6px; text-align: left; cursor: pointer; }
  .awizacja:hover { background: #e9f0fb; }
  .awizacja .details { display: none; margin-top: 8px; }
  .completed { background: #e3ffe3; }
</style>
</head>
<body>

<h1>MTM System awizacji - Strona g≈Ç√≥wna</h1>

<div>
  <button onclick="showAwizacje()">üì¶ Lista awizacji</button>
  <button onclick="window.location.href='/skaner.html'">üì∑ Skaner palet</button>
  <button onclick="window.location.href='/app_worker.html'">üë∑ Panel pracownika</button>
</div>

<hr>

<div id="awizacjeList"></div>
<div id="completedList"></div>

<script src="/script.js"></script>
<script>
// --- Pokazuje listƒô aktywnych awizacji ---
async function showAwizacje() {
  const res = await fetch('/api/awizacje');
  const data = await res.json();
  const container = document.getElementById('awizacjeList');
  container.innerHTML = '<h2>Aktywne awizacje</h2>';
  data.forEach(a => {
    const div = document.createElement('div');
    div.className = 'awizacja ' + (a.status==='zako≈Ñczony'?'completed':'');
    div.innerHTML = `
      <strong>${a.nr_zam} (${a.nazwa_zam})</strong><br>
      Ilo≈õƒá palet: ${a.ilosc_palet} | Data wyjazdu: ${a.data_awiz || '-'}<br>
      Status: ${a.status}<br>
      <div class="details">
        <button onclick="dodajPalete(${a.id})">‚ûï Dodaj paletƒô</button>
        <button onclick="editAwizacja(${a.id})">‚úèÔ∏è Edytuj</button>
        <button onclick="deleteAwizacja(${a.id})">üóëÔ∏è Usu≈Ñ</button>
        <button onclick="zako≈ÑczAwizacje(${a.id})">‚úÖ Zako≈Ñcz awizacjƒô</button>
        <button onclick="drukuj(${a.id})">üñ®Ô∏è Drukuj QR</button>
        <div>Data utworzenia: ${a.data_awiz || '-'} | Ilo≈õƒá palet: ${a.ilosc_palet}<br>
        Dodatkowe info: ${a.uwagi || '-'}</div>
      </div>
    `;
    div.onclick = (e) => {
      if(!e.target.tagName.includes('BUTTON')) {
        const details = div.querySelector('.details');
        details.style.display = details.style.display === 'block' ? 'none' : 'block';
      }
    };
    container.appendChild(div);
  });
}

// --- Funkcje akcji ---
async function dodajPalete(id) {
  const name = prompt('Nazwa palety (np. Paleta 7):');
  if(!name) return;
  const res = await fetch('/api/palety', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({awizacja_id:id,paleta_nazwa:name})});
  const j = await res.json();
  if(j.status==='ok') alert('Dodano paletƒô');
  showAwizacje();
}

async function editAwizacja(id) {
  const nr = prompt('Nowy nr zam√≥wienia:');
  const data = prompt('Nowa data wyjazdu:');
  if(!nr && !data) return;
  await fetch('/api/awizacje', { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id:id,nr_zam:nr,data_awiz:data})});
  showAwizacje();
}

async function deleteAwizacja(id) {
  if(!confirm('UsunƒÖƒá awizacjƒô?')) return;
  await fetch('/api/awizacje/'+id, { method:'DELETE' });
  showAwizacje();
}

async function zako≈ÑczAwizacje(id) {
  await fetch('/api/awizacje/zako≈Ñcz/'+id, { method:'PATCH' });
  showAwizacje();
}

function drukuj(id) {
  window.open('/api/drukuj_qr/'+id,'_blank');
}

// --- Pokazuje zako≈Ñczone zam√≥wienia ---
async function showCompleted() {
  const res = await fetch('/api/awizacje');
  const data = await res.json();
  const container = document.getElementById('completedList');
  container.innerHTML = '<h2>Zako≈Ñczone zam√≥wienia</h2>';
  data.filter(a=>a.status==='zako≈Ñczony').forEach(a=>{
    const div = document.createElement('div');
    div.className='awizacja completed';
    div.innerHTML = `<strong>${a.nr_zam} (${a.nazwa_zam})</strong><br>
      Data wyjazdu: ${a.data_awiz} | Ilo≈õƒá palet: ${a.ilosc_palet}<br>
      Dodatkowe info: ${a.uwagi || '-'}<br>
      <button onclick="deleteAwizacja(${a.id})">üóëÔ∏è Usu≈Ñ ca≈Çkowicie</button>
    `;
    container.appendChild(div);
  });
}

document.addEventListener('DOMContentLoaded', ()=>{
  showAwizacje();
  showCompleted();
});
</script>
</body>
</html>
